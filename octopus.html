<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>index</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="простой-сервер">Простой сервер</h1>
<p>Настройка и обслуживание сервера для размещения веб проектов Python, с пользованием стека Nginx + Gunicorn + Flask</p>
<h4 id="дисклеймер-disclaimer">Дисклеймер (Disclaimer)</h4>
<p>Это не универсальный метод создания веб серверов, а всего лишь частное представление того, как я это делаю для своих проектов. Поэтому как говорил одни кулинарный блогер:</p>
<blockquote>
<p>Знатоков того самого единственного правильного рецепта я попрошу сегодня не беспокоится.</p>
</blockquote>
<p>Я не сторонник простых инструкций написанных по принципу - “скопируйте сюда этот файл, а сюда перепишите эту команду и нажмите ввод”, однако и превращать эту статью в полный курс по всем аспектам затронутым в данном руководстве нет никакой возможности. Поэтому это будет некий средний вариант, где я буду показывать вам последовательность действий, попутно поясняя смысл введены команд, их ключей и параметров конфигурационных файлов.</p>
<p>Я попробую разбить руководство на некие условные этапы, но четкой градации, как мне кажется достичь просто невозможно, в том числе из-за сильной интеграции сервисов и процессов друг с другом. #### Задача</p>
<p>Нам необходимо настроить и запустить веб-сервер, на котором будет работать на проект написанный на языке Python.</p>
<p>Какой проект? Да какой угодно. Веб сайт, чат бот для Telegram или навык для Яндекс Алисы или Google Assitant`а, возможно сервис который ведет статистику пользователей вашей игры, либо даже просто статичная веб страничка, вот, например, с этой инструкцией.</p>
<h4 id="где.">Где.</h4>
<p>В первую очередь это вопрос про деньги, поскольку техническая реализация у поставщиков плюс-минус одинаковая, ну как минимум однотипная. Поэтому ответ - где угодно, смотрите, что бы вам было комфортно по платежам.</p>
<p>Регистрация доменного имени. Я для этой цели воспользовался сервисом регистрации от AWS - Route 53. Просто потому, что я давно им пользуюсь, и это не первый домен который я у них регистрирую, вы же, построюсь, можете воспользоваться услугами абсолютно любого регистратора.</p>
<p>Да, возможно кто то скажет - ну зачем я буду тратить лишние 10-20 долларов на доменное имя, если можно ходить на сервер просто по IP? И да, и нет. Современные правила предполагают использование зашифрованного соединения с нашим сервером, а сервисы предоставляющие сертификаты требуют именно зарегистрированное доменное имя, а не IP адрес. Иначе пользователь, в лучшем случае получит постоянные сообщения браузера об угрозе безопасности, а в худшем вообще не сможет зайти.</p>
<p>Итак, я только зарегистрировал имя <a href="">blueoctopus.cc</a>, и на текущий момент на нем ни одной записи.</p>
<p>Саму виртуальную машину мы сделаем в Yandex Cloud. (Да, я все понимаю, но прошу не осуждать меня).</p>
<h4 id="ключи-доступа.">Ключи доступа.</h4>
<p>Даже если это покажется странным, но начнем мы не с виртуальной, а с вашей домашней машины. Поскольку современные методы регистрации предполагают использование пары ключей <strong>SSH</strong> (<strong>S</strong>ecure <strong>SH</strong>ell), то мы их сразу и создадим, что бы при создании виртуальной машины сразу передать серверу открытую часть.</p>
<p>Итак, откроем консоль кликнув на соответствующую иконку, либо нажав комбинацию клавиш Ctrl + Alt + T (Command (⌘) + T) и сразу перейдем в каталог назначенный по умолчанию для хранения ключей.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="bu">cd</span> .ssh</span></code></pre></div>
<p>Если такой папки нет, то ее необходимо создать</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">mkdir</span> .ssh</span></code></pre></div>
<p>Ключи удобнее хранить в специально обозначенном каталоге, тогда не прийдется каждый раз при подключении указывать параметр с его размещением.</p>
<p>Если при попытке выполнить указанные выше действия вы столкнулись с ошибками, то вероятно вы используете ОС Wndows на своем десктопе. Насколько мне известно, на Windows 10 c 2018 позволяет использовать SSH, только его необходимо отдельно установить. Официальный сайт Microsoft говорит, что:</p>
<blockquote>
<p>OpenSSH можно использовать для подключения устройств с Windows 10 (версия 1809 и более поздние) Чтобы установить компоненты OpenSSH, сделайте следующее:</p>
<ol type="1">
<li>Откройте приложение Параметры, выберите элементы Приложения &gt; Приложения и возможности, щелкните Дополнительные возможности.</li>
<li>Просмотрите этот список и определите, установлено ли средство OpenSSH. Если нет, выберите пункт Добавить компонент в верхней части страницы и сделайте следующее:
<ul>
<li>Найдите Клиент OpenSSH и щелкните Установить.</li>
</ul></li>
</ol>
</blockquote>
<p>Далее проблем с подключением у пользователей Windows быть не должно.</p>
<p>И так, продолжим. Напомню, у нас открыт терминал и мы находимся в папке .ssh, напечатаем:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">max@homepc</span>:~/.ssh$  ssh-keygen</span></code></pre></div>
<p>Генератор предложит вам указать уникальное название ключа, защитить его дополнительно паролем, и вроде бы будет еще пара вопросов, которые никто не читает.</p>
<p>Уникальное имя лучше придумать, это поможет когда ключей у вас станет больше чем один, а с паролем решайте сами.</p>
<p>В итоге у вас будет два файла: server_key - это ваш приватный ключ, его необходимо оставить в папке .ssh вашей домашней директории, и никому никогда не передавать. И server_key.pub - это, соответственно, публичная часть, содержимое которого необходимо загрузить при создании конфигурации нашей виртуальной машины.</p>
<p>Выведем содержимое публичного ключа и скопируем его в буфер обмена.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">cat</span> server_key.pub</span></code></pre></div>
<p>Для удобства, большой точности и безопасности копирования в буфер можно воспользоваться утилитами xclip для Linux и pbcopy для MacOS.</p>
<h4 id="виртуальная-машина-в-yandex-cloud">Виртуальная машина в Yandex Cloud</h4>
<p>Теперь откроем консоль <a href="https://console.cloud.yandex.ru/">Yandex Cloud</a>. Если у вас нет аккаунта, то его придется создать. Думаю, что с регистрацией на Яндекс проблем не возникнет.</p>
<p>Далее в меню слева выбираем раздел <strong>Compute Cloud</strong> и нажимаем кнопку <strong>Создать ВМ</strong>. Я специально решил делать этот пример на сервисах яндекса, поскольку у них есть подробное описание каждого пункта меню на русском языке.</p>
<p>Большинство параметров в этом примере мы оставим по умолчанию, либо выберем минимальные, поскольку при возникновении потребности в дальнейшем увеличить их не составит труда.</p>
<p>Давайте быстро пройдемся по пунктам:</p>
<p><strong>Имя и описание</strong> - все понятно, уникальное название и некоторые подробности, что бы вы сами не забыли что это за виртуалка крутится у вас в облаке.</p>
<p><strong>Зона доступности</strong> - мне яндекс предложил <strong>ru-central-b</strong>, так и оставлю.</p>
<p><strong>Операционная система</strong> - Ubuntu 20.04</p>
<p><strong>Диск</strong> - HDD на 13 Gb</p>
<p><strong>Платформа</strong> - Intel Ice Lake</p>
<p><strong>vCPU</strong> - 2 (Количество ядер процессора, наверное хватило бы и одного, но яндекс так уже не предлагает)</p>
<p><strong>Гарантированная доля vCPU</strong> - 20% (Минимальная гарантированная доля производительности. По моему опыту, при настройке загрузка ЦП не превышает 1-2%, так что этой доли нам более чем достаточно не только для настройки сервера, но и для небольших сервисов развернутых на нем.)</p>
<p><strong>RAM</strong> - Очевидно оперативная память. Выбирайте минимум 2 GB</p>
<p><strong>Прерываемая</strong> - самый спорный пункт. Его выбор делает большую скидку на ВМ, однако это дает право яндексу остановить ее в любой момент. Сервер будет остановлен коррекно, так что за сохранность данных переживать не стоит, но включать его обратно прийдется “вручную”. Для этого урока я этот пункт включу, но если настраиваемый вами сервер планируется в дальнейшем использовать в рабочем режиме, то выбирать этот пункт точно не стоит.</p>
<p>В <strong>сетевых настройках</strong> нас интересует только пункт <strong>Публичный адрес</strong>, все остальное оставляем без изменений.</p>
<p>Думаю здесь необходимо небольшое пояснение - в автоматическом режиме яндекс, конечно, предоставит публичный адрес, но проблема в том что при каждом перезапуске сервера он будет новым, что неприемлемо для настройки доменного имени. И да, это стоит отдельных денег, это нормально. Постоянно зарезервированный адрес стоит немного дороже, чем автоматический, и еще дороже будет стоить зарезервированный, но неиспользуемый адрес. (На момент написания этой статьи это около 150 рублей в месяц.)</p>
<p>В любом случае, когда вы выберите пункт “список”, то скорее всего получите сообщение о том, что в вашем облаке нет свободных статических IP-адресов. В конце этого сообщения будет ссылка с названием “список адресов”, смело нажимаем на нее и попадаем в раздел Virtual Private Cloud.</p>
<p>Выбираем в меню слева пункт “IP-адреса”, и потом жмем на кнопку “Зарезервировать адрес”, тут главное проследить что бы зона доступности, где резервируется адрес была той же, где создается сервер. Если все правильно - нажимаем “Зарезервировать” и возвращаемся к конфигурированию нашей ВМ.</p>
<p>Теперь при настройке публичного адреса в пункте список будет доступен наш зарезервированный IP. Выберем его и перейдем к настройке доступа.</p>
<p><strong>Сервисный аккаунт</strong> - нужен если вы планируете получать доступ с виртуальной машины к другим ресурсам облака. (Например к серверу базы данных). В данном случае в нем нет необходимости.</p>
<p><strong>Логин</strong> - имя пользователя в на сервере. Тут все просто, главное не выбирайте root</p>
<p><strong>SSH-ключ</strong> - содержимое того самого server_key.pub, которое мы скопировали в буфер обмена. Просто вставьте его сюда.</p>
<p><strong>Доступ к серийной консоли не включаем.</strong> Считайте это аварийным режимом, который в штатном режиме должен быть отключен.</p>
<p>Ну вот, теперь внимательно смотрим на правую колонку, и если цена нас устраивает - жмем на кнопку <strong>Создать ВМ</strong> внизу страницы.</p>
</body>
</html>
